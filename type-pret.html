<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Types de Pr√™t</title>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .form-container {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    input, button { 
      margin: 5px; 
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input[type="text"], input[type="number"] {
      width: 200px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
      font-weight: bold;
    }
    button:hover {
      background-color: #0056b3;
    }
    .btn-edit {
      background-color: #28a745;
      padding: 5px 10px;
      font-size: 12px;
    }
    .btn-edit:hover {
      background-color: #218838;
    }
    .btn-delete {
      background-color: #dc3545;
      padding: 5px 10px;
      font-size: 12px;
    }
    .btn-delete:hover {
      background-color: #c82333;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px;
      background-color: white;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 12px; 
      text-align: left; 
    }
    th { 
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #e9ecef;
    }
    .navigation {
      margin-bottom: 20px;
    }
    .nav-link {
      display: inline-block;
      margin-right: 20px;
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
    .nav-link:hover {
      text-decoration: underline;
    }
    .taux-cell {
      text-align: right;
      font-weight: bold;
      color: #28a745;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="navigation">
    <a href="index.html" class="nav-link">‚Üê Retour aux √âtudiants</a>
  </div>

  <h1>Gestion des Types de Pr√™t</h1>

  <div class="form-container">
    <input type="hidden" id="id">
    <input type="text" id="libelle" placeholder="Libell√© du type de pr√™t">
    <input type="number" id="taux" placeholder="Taux (%)" step="0.01" min="0" max="100">
    <input type="number" id="taux_assurance" placeholder="Taux assurance (%)" step="0.01" min="0" max="100">
    <button onclick="ajouterOuModifier()">Ajouter / Modifier</button>
    <button onclick="resetForm()" style="background-color: #6c757d;">Annuler</button>
  </div>

  <table id="table-type-prets">
    <thead>
      <tr>
        <th>Libell√©</th>
        <th>Taux (%)</th>
        <th>Taux Assurance (%)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const apiBase = "http://localhost/banque/ws";

  function ajax(method, url, data, callback, errorCallback) {
    const xhr = new XMLHttpRequest();
    xhr.open(method, apiBase + url, true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            callback(response);
          } catch (e) {
            if (errorCallback) errorCallback(`Erreur de parsing JSON: ${e.message}`);
            else alert(`Erreur de parsing JSON: ${e.message}`);
          }
        } else {
          let errorMessage = `Erreur HTTP ${xhr.status}`;
          try {
            const errorResponse = JSON.parse(xhr.responseText);
            errorMessage += `: ${errorResponse.error || errorResponse.message || 'Erreur inconnue'}`;
          } catch (e) {
            errorMessage += `: ${xhr.responseText || 'Erreur inconnue'}`;
          }
          if (errorCallback) errorCallback(errorMessage);
          else alert(errorMessage);
        }
      }
    };
    xhr.send(data);
  }

  function chargerTypePrets() {
    ajax("GET", "/type-prets", null, (data) => {
      const tbody = document.querySelector("#table-type-prets tbody");
      tbody.innerHTML = "";
      
      // V√©rifier si data est un tableau
      if (!Array.isArray(data)) {
        console.error('Les donn√©es re√ßues ne sont pas un tableau:', data);
        tbody.innerHTML = '<tr><td colspan="5">Erreur: Format de donn√©es invalide</td></tr>';
        return;
      }
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Aucun type de pr√™t trouv√©</td></tr>';
        return;
      }
      
      data.forEach(typePret => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${typePret.libelle}</td>
          <td class="taux-cell">${parseFloat(typePret.taux).toFixed(2)}%</td>
          <td class="taux-cell">${parseFloat(typePret.taux_assurance || 0).toFixed(2)}%</td>
          <td>
            <button class="btn-edit" onclick='remplirFormulaire(${JSON.stringify(typePret)})'>‚úèÔ∏è Modifier</button>
            <button class="btn-delete" onclick='supprimerTypePret(${typePret.id})'>üóëÔ∏è Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }, (error) => {
      console.error('Erreur lors du chargement:', error);
      const tbody = document.querySelector("#table-type-prets tbody");
      tbody.innerHTML = `<tr><td colspan="5">Erreur: ${error}</td></tr>`;
    });
  }

  function ajouterOuModifier() {
    const id = document.getElementById("id").value;
    const libelle = document.getElementById("libelle").value;
    const taux = document.getElementById("taux").value;
    const taux_assurance = document.getElementById("taux_assurance").value || 0;

    if (!libelle || !taux) {
      alert("Veuillez remplir au minimum le libell√© et le taux");
      return;
    }

    if (parseFloat(taux) < 0 || parseFloat(taux) > 100) {
      alert("Le taux doit √™tre compris entre 0 et 100%");
      return;
    }

    if (parseFloat(taux_assurance) < 0 || parseFloat(taux_assurance) > 100) {
      alert("Le taux d'assurance doit √™tre compris entre 0 et 100%");
      return;
    }

    const data = `libelle=${encodeURIComponent(libelle)}&taux=${taux}&taux_assurance=${taux_assurance}`;

    if (id) {
      ajax("PUT", `/type-prets/${id}`, data, (response) => {
        alert(response.message);
        resetForm();
        chargerTypePrets();
      }, (error) => {
        alert("Erreur lors de la modification: " + error);
      });
    } else {
      ajax("POST", "/type-prets", data, (response) => {
        alert(response.message);
        resetForm();
        chargerTypePrets();
      }, (error) => {
        alert("Erreur lors de l'ajout: " + error);
      });
    }
  }

  function remplirFormulaire(typePret) {
    document.getElementById("id").value = typePret.id;
    document.getElementById("libelle").value = typePret.libelle;
    document.getElementById("taux").value = typePret.taux;
    document.getElementById("taux_assurance").value = typePret.taux_assurance || 0;
  }

  function supprimerTypePret(id) {
    if (confirm("√ätes-vous s√ªr de vouloir supprimer ce type de pr√™t ?")) {
      ajax("DELETE", `/type-prets/${id}`, null, (response) => {
        alert(response.message);
        chargerTypePrets();
      }, (error) => {
        alert("Erreur lors de la suppression: " + error);
      });
    }
  }

  function resetForm() {
    document.getElementById("id").value = "";
    document.getElementById("libelle").value = "";
    document.getElementById("taux").value = "";
    document.getElementById("taux_assurance").value = "";
  }

  // Charger les types de pr√™t au d√©marrage
  chargerTypePrets();
</script>

</body>
</html>
